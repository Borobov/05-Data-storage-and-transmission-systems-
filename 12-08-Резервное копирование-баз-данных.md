# Домашнее задание к занятию «Резервное копирование баз данных»

### Боробов И.С.

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.  

### Ответ:
Можно использовать любой тип резервного копирования, но лучше использовать **дифференциальный**: раз в неделю делать полный бекап и ежедневно дифференциальный.  
Данный вариант будет экономичее чем полный ежеденный и более надежный и простой чем ежедневный инкрементный к полному еженедельному.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.  

### Ответ:
Возможно использование дифференциального и инкрементного бекапа. Я бы использовал инкрементный бекап по следующей схеме: ежедневно делал полный бекап и в течении дня инкрементный раз в час (или чаще, если это требуется). Данная модель бекапа позволит быстро делеать инкрементные копии в течении дня и экономить место. Так же в случае сбоя в инкрементной цепочке, будет ежедневная полная копия.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.  

### Ответ:
Можно использовать два mySQL сервера в режиме master-master (Active-Passive) репликацию и использовать потокол CARP (Common Address Redundancy Protocol — протокол дупликации общего адреса, основной задачей которого является использование одного IP-адреса несколькими хостами в пределах сегмента сети).  

Также можно использовать mysqlfailover.  
Эта утилита позволяет пользователям выполнять мониторинг работоспособности репликации и автоматический переход на другой ресурс в топологии репликации, состоящей из одного главного и его подчиненных устройств. Утилита предназначена для интерактивного или непрерывного обновления информации о работоспособности и периодической проверки основного состояния. Его основная задача — следить за сбоем ведущего, а при возникновении сбоя выполнять аварийное переключение на одно из ведомых устройств, которое находится в допустимом состоянии. Утилита принимает необязательный список ведомых устройств, которые следует рассматривать для кандидата в ведомые устройства.  
Источник: https://manpages.debian.org/unstable/mysql-utilities/mysqlfailover.1.en.html

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

### Ответ:
Создание резервной копии:  
pg_dump -U borobov -W test_db > /backup/test_db.dump  

Восстановление из резервной копии:  
pg_restore -d test_db /backup/test_db.dump  

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Ответ:

Скрипт:
```
#!/bin/sh
PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

pgpass=password
export pgpass
dbuser=borobov
database=test_db

find /backup -name "*.dump" -type -f -mtime +30 -delete
pg_dump -U $dbuser $database | gzip > /backup/pgsql_$(date "+%Y-%m-%d").sql.gz

unset pgpass
```

Добавил в crone, запускать ежедневно в 01:00:
```
1 0 * * * /scripts/postgres-backup.sh
```

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Ответ:
Percona XtraBackup — это утилита для горячего резервного копирования баз данных MySQL. Во время создания резервной копии данных не происходит блокировок таблиц, ваша система продолжает работать без каких бы то ни было ограничений. 

Пример команды инкрементного резервного копирования базы данных MySQL  
xtrabackup --backup --target-dir=/data/backup/inc1 --incremental-basedir=/data/backup/full  

---

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.
